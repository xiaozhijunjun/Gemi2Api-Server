name: Update Upstream Dependencies

on:
  schedule:
    # æ¯å¤© UTC 02:00 æ£€æŸ¥æ›´æ–° (åŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹)
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      
    - name: Get current gemini-webapi version
      id: current_version
      run: |
        current_version=$(grep -o 'gemini-webapi>=[0-9]\+\.[0-9]\+\.[0-9]\+' pyproject.toml | sed 's/gemini-webapi>=//')
        echo "current=$current_version" >> $GITHUB_OUTPUT
        echo "Current version: $current_version"
        
    - name: Check latest upstream release
      id: latest_version
      run: |
        latest_version=$(curl -s "https://api.github.com/repos/HanaokaYuzu/Gemini-API/releases/latest" | python3 -c "import sys, json; print(json.load(sys.stdin)['tag_name'].lstrip('v'))")
        echo "latest=$latest_version" >> $GITHUB_OUTPUT
        echo "Latest version: $latest_version"
        
    - name: Compare versions
      id: version_check
      run: |
        current="${{ steps.current_version.outputs.current }}"
        latest="${{ steps.latest_version.outputs.latest }}"
        
        if [ "$current" != "$latest" ]; then
          echo "needs_update=true" >> $GITHUB_OUTPUT
          echo "Version update needed: $current -> $latest"
        else
          echo "needs_update=false" >> $GITHUB_OUTPUT
          echo "Already up to date: $current"
        fi
        
    - name: Update pyproject.toml
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        current="${{ steps.current_version.outputs.current }}"
        latest="${{ steps.latest_version.outputs.latest }}"
        
        # æ›´æ–° pyproject.toml ä¸­çš„ç‰ˆæœ¬å·
        sed -i "s/gemini-webapi>=$current/gemini-webapi>=$latest/g" pyproject.toml
        
        echo "Updated gemini-webapi version from $current to $latest"
        
    - name: Update lock file
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        uv lock --upgrade-package gemini-webapi
        
    - name: Test installation
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        uv sync
        uv run python -c "import gemini_webapi; print('gemini-webapi imported successfully')"
        
    - name: Run linting
      if: steps.version_check.outputs.needs_update == 'true'
      run: |
        uv run ruff check .
        uv run ruff format --check .
        
    - name: Create Pull Request
      if: steps.version_check.outputs.needs_update == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          âœ¨ feat: å‡çº§ä¸Šæ¸¸ç‰ˆæœ¬ gemini-webapi è‡³ v${{ steps.latest_version.outputs.latest }}
          
          - è‡ªåŠ¨æ›´æ–° gemini-webapi ä» v${{ steps.current_version.outputs.current }} åˆ° v${{ steps.latest_version.outputs.latest }}
          - æ›´æ–° uv.lock æ–‡ä»¶
          - éªŒè¯å®‰è£…å’Œä»£ç æ ¼å¼
        title: 'â¬†ï¸ è‡ªåŠ¨æ›´æ–°ä¸Šæ¸¸ä¾èµ–: gemini-webapi v${{ steps.latest_version.outputs.latest }}'
        body: |
          ## ğŸ”„ è‡ªåŠ¨ä¸Šæ¸¸ç‰ˆæœ¬æ›´æ–°
          
          æ­¤ PR è‡ªåŠ¨æ›´æ–°äº†ä¸Šæ¸¸ä¾èµ–ç‰ˆæœ¬ï¼š
          
          - **gemini-webapi**: `${{ steps.current_version.outputs.current }}` â†’ `${{ steps.latest_version.outputs.latest }}`
          - **ä¸Šæ¸¸å‘å¸ƒé¡µé¢**: https://github.com/HanaokaYuzu/Gemini-API/releases/tag/v${{ steps.latest_version.outputs.latest }}
          
          ### âœ… è‡ªåŠ¨éªŒè¯å®Œæˆ
          
          - [x] ä¾èµ–å®‰è£…æµ‹è¯•é€šè¿‡
          - [x] ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡
          - [x] uv.lock æ–‡ä»¶å·²æ›´æ–°
          
          ### ğŸ“‹ æ‰‹åŠ¨æ£€æŸ¥æ¸…å•
          
          åœ¨åˆå¹¶æ­¤ PR å‰ï¼Œè¯·ç¡®è®¤ï¼š
          
          - [ ] æŸ¥çœ‹ä¸Šæ¸¸æ›´æ”¹æ—¥å¿—ï¼Œç¡®è®¤æ— ç ´åæ€§å˜æ›´
          - [ ] æœ¬åœ°æµ‹è¯• API åŠŸèƒ½æ­£å¸¸
          - [ ] ç¡®è®¤æ–°ç‰ˆæœ¬å…¼å®¹ç°æœ‰åŠŸèƒ½
          
          ---
          
          ğŸ¤– æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
        branch: auto-update/gemini-webapi-v${{ steps.latest_version.outputs.latest }}
        delete-branch: true
        draft: false
        labels: |
          dependencies
          enhancement
          automated